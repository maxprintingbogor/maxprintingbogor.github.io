<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Layout Polaroid Center</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin:20px;
  font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background:#f5f5f5;
  color:#222;
  transition: background-color 0.4s ease, color 0.4s ease;
}
#controls {
  display:flex; flex-wrap:wrap; gap:10px; align-items:center;
  margin-bottom:15px; padding:15px; background:#fff;
  border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);
  transition: background-color 0.4s ease, border-color 0.4s ease;
}
select, textarea, input[type="file"], input[type="color"] {
  padding:8px 12px; border-radius:6px; border:1px solid #ccc; font-size:14px;
  transition: background-color 0.4s ease, color 0.4s ease, border-color 0.4s ease;
}
textarea { flex:1; min-width:300px; resize:vertical; }
button {
  padding:10px 16px; border:none; border-radius:6px;
  background:linear-gradient(90deg,#4facfe,#00f2fe);
  color:white; font-weight:bold; cursor:pointer; transition:0.3s;
}
button:hover { background:linear-gradient(90deg,#00f2fe,#4facfe); }
#darkToggle { background:#444; color:#fff; }
#darkToggle:hover { background:#666; }

#folderName {
  font-weight:bold;
  color:#0070c0;
  margin:8px 0 5px;
  font-size:15px;
}

#preview { display:flex; flex-wrap:wrap; gap:10px; margin-top:10px; }
#preview img {
  height:120px; border:2px solid #ddd; border-radius:6px; object-fit:cover; transition: transform 0.2s;
  cursor:pointer;
}
#preview img:hover { transform:scale(1.05); }

#progressContainer {
  width:100%; margin:10px 0; display:none; background:#eee;
  border-radius:10px; overflow:hidden; position:relative; height:25px;
}
#progressBar { width:0%; height:100%; background:linear-gradient(90deg,#4facfe,#00f2fe); transition:width 0.3s; }
#progressText { position:absolute; width:100%; top:0; left:0; text-align:center; font-size:14px; line-height:25px; color:#333; font-weight:bold; transition: color 0.4s ease; }

#infoKeterangan { margin:5px 0 10px; font-size:14px; font-weight:bold; color:#222; transition: color 0.4s ease; }
#appVersion { width:100%; text-align:right; font-size:12px; color:#555; margin-top:5px; font-style:italic; transition: color 0.4s ease; }

@media(max-width:768px){ #controls { flex-direction:column; align-items:flex-start; } textarea { min-width:100%; } }
@media(max-width:600px){ #preview img { height:200px; } }

/* Mode Gelap */
body.dark-mode { background-color:#121212; color:#f1f1f1; }
body.dark-mode #controls { background:#1e1e1e; border:1px solid #333; }
body.dark-mode input, body.dark-mode select, body.dark-mode button, body.dark-mode textarea {
  background:#333; color:#f1f1f1; border:1px solid #555;
}
body.dark-mode #preview { background:#222; }
body.dark-mode #progressContainer { background:#333; }
body.dark-mode #progressText { color:#ffeb3b; }
body.dark-mode #infoKeterangan { color:#ffeb3b; }
body.dark-mode #appVersion { color:#aaa; }
body.dark-mode #darkToggle { background:#ff9800; color:#000; }

#autoCaptionContainer {
  width: 100%;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 14px;
  color: #333;
  margin-top: 4px;
}

/* Modal Zoom */
#imgModal {
  display:none; position:fixed; z-index:9999; left:0; top:0;
  width:100%; height:100%; background:rgba(0,0,0,0.9);
  justify-content:center; align-items:center;
}
#imgModal img {
  max-width:90%; max-height:90%; border-radius:10px;
  box-shadow:0 0 20px rgba(255,255,255,0.3);
}
</style>
</head>
<body>

<div id="controls">
  <!-- note: webkitdirectory ditambahkan agar bisa pilih folder -->
  <input type="file" id="upload" webkitdirectory directory multiple accept="image/*">
  <select id="sizeSelect">
    <option value="6x9">2R (6x9 cm)</option>
    <option value="8.9x12.7">3R (8.9x12.7 cm)</option>
    <option value="10.2x15.2">4R (10.2x15.2 cm)</option>
    <option value="12.7x17.8">5R (12.7x17.8 cm)</option>
    <option value="15.2x20.3">6R (15.2x20.3 cm)</option>
    <option value="20.3x25.4">8R (20.3x25.4 cm)</option>
  </select>
  <select id="bgSelect">
    <option value="white">Putih</option>
    <option value="black">Hitam</option>
    <option value="gray">Abu-abu</option>
    <option value="blue">Biru</option>
    <option value="cream">Cream</option>
    <option value="pink">Pink</option>
    <option value="custom">Custom Warna</option>
    <option value="image">Background Gambar</option>
  </select>
  <input type="color" id="customColor" style="display:none;">
  <input type="file" id="bgImageInput" accept="image/*" style="display:none;">
  <textarea id="captionInput" placeholder="Tulis caption di sini" rows="2"></textarea>
  
  <!-- ADDED: Checkbox Auto Caption (tidak mengganggu layout) -->
  <div id="autoCaptionContainer">
    <input type="checkbox" id="autoCaption">
    <label for="autoCaption">Isi otomatis dari nama folder</label>
  </div>

  <label><input type="checkbox" id="marginColorToggle" checked> Margin Berwarna</label>
  <button id="savePDF">Simpan PDF</button>
  <button id="resetBtn">Reset</button>
  <button id="darkToggle">ðŸŒ™ Mode Malam</button>
</div>

<!-- indikator nama folder yang dipilih -->
<div id="folderName"></div>

<div id="appVersion">Versi 1.4.3</div>
<div id="progressContainer">
  <div id="progressBar"></div>
  <div id="progressText">0%</div>
</div>
<div id="infoKeterangan"></div>
<div id="preview"></div>

<!-- Modal Zoom -->
<div id="imgModal"><img id="modalImg" src="" alt="Preview Besar"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
/* ---------------- helper loadImage ---------------- */
function loadImage(src){
  return new Promise((resolve, reject) => {
    const img = new Image();
    img.onload = () => resolve(img);
    img.onerror = reject;
    img.src = src;
  });
}

/* ---------------- elements ---------------- */
const { jsPDF } = window.jspdf;
const upload = document.getElementById('upload');
const folderNameDiv = document.getElementById('folderName');
const sizeSelect = document.getElementById('sizeSelect');
const bgSelect = document.getElementById('bgSelect');
const customColor = document.getElementById('customColor');
const bgImageInput = document.getElementById('bgImageInput');
const captionInput = document.getElementById('captionInput');
const saveBtn = document.getElementById('savePDF');
const resetBtn = document.getElementById('resetBtn');
const previewDiv = document.getElementById('preview');
const progressContainer = document.getElementById('progressContainer');
const progressBar = document.getElementById('progressBar');
const progressText = document.getElementById('progressText');
const infoKeterangan = document.getElementById('infoKeterangan');
const marginColorToggle = document.getElementById('marginColorToggle');
const darkToggle = document.getElementById('darkToggle');

const autoCaptionCheckbox = document.getElementById('autoCaption');

let currentFiles = [];
let bgImageObj = null;

const autoColors = ["#ff0000","#00b050","#0070c0","#7030a0","#FFDC00","#00EAFF","#ff69b4","#828282","#C28FF3","#91E7FF"];
let colorIndex = -1, currentColor = autoColors[0];

const layoutConfig = {
  "6x9": {margin:0.5, border:0.5, bottom:1.5},
  "8.9x12.7": {margin:0.6, border:0.6, bottom:1.6},
  "10.2x15.2": {margin:0.7, border:0.7, bottom:1.7},
  "12.7x17.8": {margin:0.8, border:0.8, bottom:1.8},
  "15.2x20.3": {margin:0.9, border:0.9, bottom:1.9},
  "20.3x25.4": {margin:1.0, border:1.0, bottom:2.0}
};
function getLayoutConfig(){ return layoutConfig[sizeSelect.value] || {margin:0.5,border:0.5,bottom:1.5}; }

/* ---------------- bg image input ---------------- */
bgSelect.addEventListener("change", () => {
  customColor.style.display = bgSelect.value === "custom" ? "inline-block" : "none";
  bgImageInput.style.display = bgSelect.value === "image" ? "inline-block" : "none";
});

bgImageInput.addEventListener("change", (e) => {
  if (!e.target.files.length) { bgImageObj=null; return; }
  const reader = new FileReader();
  reader.onload = async (ev) => {
    try { bgImageObj = await loadImage(ev.target.result); }
    catch(err) { console.error("Gagal load bg image", err); bgImageObj = null; }
  };
  reader.readAsDataURL(e.target.files[0]);
});

/* ---------------- kalkulasi layout ---------------- */
function calculateOptimal(w,h){
  const {margin} = getLayoutConfig();
  const opts=[
    {pageW:32,pageH:48,w:w,h:h,orientation:'portrait'},
    {pageW:48,pageH:32,w:w,h:h,orientation:'landscape'}
  ];
  let best=opts[0],max=0;
  opts.forEach(opt=>{
    const cols=Math.floor((opt.pageW-2*margin)/opt.w);
    const rows=Math.floor((opt.pageH-2*margin)/opt.h);
    const per=cols*rows;
    if(per>max){max=per;best=opt;}
  });
  return best;
}
function updateKeterangan(){
  if(!currentFiles.length){infoKeterangan.textContent="";return;}
  const [w,h]=sizeSelect.value.split('x').map(Number);
  const opt=calculateOptimal(w,h);
  const {margin}=getLayoutConfig();
  const cols=Math.floor((opt.pageW-2*margin)/opt.w);
  const rows=Math.floor((opt.pageH-2*margin)/opt.h);
  const perPage=cols*rows||1;
  const lembar=Math.ceil(currentFiles.length/perPage);
  infoKeterangan.textContent=`${currentFiles.length} foto = ${lembar} lembar (${perPage} foto / lembar)`;
}

/* ---------------- upload change -> preview + folder name ---------------- */
upload.addEventListener('change', async () => {
  currentFiles = Array.from(upload.files);
  previewDiv.innerHTML = ""; 
  updateKeterangan(); // update keterangan awal (akan kosong kalau belum ada file)

  // tampilkan nama folder apabila tersedia (webkitRelativePath tersedia saat pilih folder)
  if (currentFiles.length > 0) {
    const firstPath = currentFiles[0].webkitRelativePath || currentFiles[0].name;
    const folderName = firstPath.includes('/') ? firstPath.split('/')[0] : "(Folder Tidak Dikenali)";
    folderNameDiv.textContent = "ðŸ“ Folder: " + folderName;
  } else {
    folderNameDiv.textContent = "";
  }

  if(currentFiles.length>0){ colorIndex=(colorIndex+1)%autoColors.length; currentColor=autoColors[colorIndex]; }

  for(const file of currentFiles){
    try{
      const img = await loadImage(URL.createObjectURL(file));
      const [w,h] = sizeSelect.value.split('x').map(Number);
      const data = await createPolaroid(img, w, h, 72, bgSelect.value, customColor.value, bgImageObj);
      const thumb = document.createElement('img');
      thumb.src = data;
      previewDiv.appendChild(thumb);
    }catch(err){ console.error("Gagal thumbnail", err); }
  }

  updateKeterangan();
});
sizeSelect.addEventListener("change", updateKeterangan);

/* ---------------- createPolaroid (sama seperti aslinya) ---------------- */
async function createPolaroid(img,W,H,dpi,bgOption,customCol,bgImgObjParam){
  const {border,bottom}=getLayoutConfig();
  const canvas=document.createElement('canvas');
  canvas.width=Math.round(W*dpi); canvas.height=Math.round(H*dpi);
  const ctx=canvas.getContext('2d');
  if(bgOption==="image"&&bgImgObjParam){
    const bg=bgImgObjParam;
    const scale=Math.max(canvas.width/bg.width,canvas.height/bg.height);
    const x=(canvas.width-bg.width*scale)/2;
    const y=(canvas.height-bg.height*scale)/2;
    ctx.drawImage(bg,x,y,bg.width*scale,bg.height*scale);
  }else{
    ctx.fillStyle=bgOption==="custom"?customCol:bgOption;
    ctx.fillRect(0,0,canvas.width,canvas.height);
  }
  let drawImg=img;
  if(img.width>img.height){
    const rotated=document.createElement('canvas');
    rotated.width=img.height; rotated.height=img.width;
    const rctx=rotated.getContext('2d');
    rctx.translate(img.height,0); rctx.rotate(Math.PI/2);
    rctx.drawImage(img,0,0); drawImg=rotated;
  }
  const photoW=canvas.width-border*2*dpi;
  const photoH=canvas.height-(border+bottom)*dpi;
  const photoX=border*dpi,photoY=border*dpi;
  const ratio=Math.min(photoW/drawImg.width,photoH/drawImg.height);
  const drawW=drawImg.width*ratio,drawH=drawImg.height*ratio;
  const offsetX=photoX+(photoW-drawW)/2,offsetY=photoY+(photoH-drawH)/2;
  ctx.drawImage(drawImg,offsetX,offsetY,drawW,drawH);
  return canvas.toDataURL("image/jpeg",0.92);
}

/* ---------------- save to PDF (original behavior preserved) ---------------- */
saveBtn.addEventListener('click', async () => {
  if(!currentFiles.length) return alert("Upload foto dulu!");
  const [w,h]=sizeSelect.value.split('x').map(Number);
  const {margin}=getLayoutConfig();
  const opt=calculateOptimal(w,h);
  const pdf=new jsPDF({unit:'cm',format:[opt.pageW,opt.pageH],orientation:opt.orientation});
  const cols=Math.floor((opt.pageW-2*margin)/opt.w);
  const rows=Math.floor((opt.pageH-2*margin)/opt.h);
  const perPage=Math.max(1,cols*rows);
  progressContainer.style.display="block";
  let done=0,total=currentFiles.length;
  for(let i=0;i<currentFiles.length;i+=perPage){
    if(i>0) pdf.addPage();
    const pageFiles=currentFiles.slice(i,i+perPage);
    const totalW=cols*opt.w,totalH=rows*opt.h;
    const left=margin+(opt.pageW-2*margin-totalW)/2;
    const top=margin+(opt.pageH-2*margin-totalH)/2;
    if(marginColorToggle.checked){
      const r=parseInt(currentColor.substr(1,2),16);
      const g=parseInt(currentColor.substr(3,2),16);
      const b=parseInt(currentColor.substr(5,2),16);
      pdf.setFillColor(r,g,b);
      pdf.rect(0,0,opt.pageW,margin,"F");
      pdf.rect(0,0,margin,opt.pageH,"F");
      pdf.rect(opt.pageW-margin,0,margin,opt.pageH,"F");
    }
    pdf.setLineWidth(0.02);
    for(let c=0;c<=cols;c++){const x=left+c*opt.w;pdf.line(x,top-0.7,x,top-0.2);pdf.line(x,top+totalH+0.2,x,top+totalH+0.7);}
    for(let r=0;r<=rows;r++){const y=top+r*opt.h;pdf.line(left-0.7,y,left-0.2,y);pdf.line(left+totalW+0.2,y,left+totalW+0.7,y);}
    pdf.setFontSize(14);
    pdf.text(captionInput.value||"",opt.pageW/2,top+totalH+1.2,{align:"center"});
    const tasks=pageFiles.map(async(file,idx)=>{
      const img=await loadImage(URL.createObjectURL(file));
      const data=await createPolaroid(img,opt.w,opt.h,200,bgSelect.value,customColor.value,bgImageObj);
      const col=idx%cols,row=Math.floor(idx/cols);
      const x=left+col*opt.w,y=top+row*opt.h;
      pdf.addImage(data,'JPEG',x,y,opt.w,opt.h);
      done++;const percent=((done/total)*100).toFixed(1);
      progressBar.style.width=percent+"%";progressText.textContent=percent+"%";
    });
    await Promise.all(tasks);
  }
  let filename=captionInput.value.trim()||"layout-polaroid";
  filename=filename.replace(/[^a-zA-Z0-9-_ ]/g,"");
  pdf.save(filename+".pdf");
  progressContainer.style.display="none";progressBar.style.width="0%";progressText.textContent="0%";
});

/* ---------------- reset ---------------- */
resetBtn.addEventListener('click',()=>{
  upload.value="";currentFiles=[];
  sizeSelect.value="6x9";bgSelect.value="white";
  customColor.value="#ffffff";customColor.style.display="none";
  bgImageInput.value="";bgImageInput.style.display="none";bgImageObj=null;
  captionInput.value="";previewDiv.innerHTML="";infoKeterangan.textContent="";
  folderNameDiv.textContent = "";
  progressContainer.style.display="none";progressBar.style.width="0%";progressText.textContent="0%";
});

/* ---------------- dark mode persistence ---------------- */
if(localStorage.getItem("dark-mode")==="enabled"){
  document.body.classList.add("dark-mode");
  darkToggle.textContent="â˜€ï¸ Mode Terang";
}
darkToggle.addEventListener("click",()=>{
  document.body.classList.toggle("dark-mode");
  if(document.body.classList.contains("dark-mode")){
    localStorage.setItem("dark-mode","enabled");
    darkToggle.textContent="â˜€ï¸ Mode Terang";
  }else{
    localStorage.setItem("dark-mode","disabled");
    darkToggle.textContent="ðŸŒ™ Mode Malam";
  }
});

/* ---------------- Modal Zoom ---------------- */
const imgModal=document.getElementById("imgModal");
const modalImg=document.getElementById("modalImg");
previewDiv.addEventListener("click",(e)=>{
  if(e.target.tagName==="IMG"){modalImg.src=e.target.src;imgModal.style.display="flex";}
});
imgModal.addEventListener("click",()=>{imgModal.style.display="none";});

/* ---------------- AUTO-CAPTION: logic tambahan (safe, non-intrusive) ---------------- */
let currentFolderName = "";

function hitungLembarA3_forAutoCaption() {
  if (!currentFiles.length) return 0;
  // gunakan calculateOptimal & getLayoutConfig supaya konsisten dengan hitungan utama
  const [w,h] = sizeSelect.value.split('x').map(Number);
  const opt = calculateOptimal(w,h);
  const {margin} = getLayoutConfig();
  const cols = Math.floor((opt.pageW - 2*margin) / opt.w);
  const rows = Math.floor((opt.pageH - 2*margin) / opt.h);
  const perPage = Math.max(1, cols * rows);
  return Math.ceil(currentFiles.length / perPage);
}

function isiAutoCaption(){
  if (!autoCaptionCheckbox.checked) return;
  if (!currentFiles.length) {
    // kosongkan jika tidak ada file
    captionInput.value = "";
    return;
  }
  // determine folder name (try to read from file paths)
  if (!currentFolderName && currentFiles.length) {
    const firstPath = currentFiles[0].webkitRelativePath || currentFiles[0].name;
    currentFolderName = firstPath.includes('/') ? firstPath.split('/')[0] : "(Folder Tidak Dikenali)";
  }
  const lembar = hitungLembarA3_forAutoCaption();
  captionInput.value = `${currentFolderName} - ${lembar} Lembar A3`;
}

// listen for upload changes (add-on listener; doesn't replace existing behavior)
upload.addEventListener('change', () => {
  // update currentFiles (already updated by the main handler, but keep in sync)
  currentFiles = Array.from(upload.files || []);
  if (currentFiles.length) {
    const firstPath = currentFiles[0].webkitRelativePath || currentFiles[0].name;
    currentFolderName = firstPath.includes('/') ? firstPath.split('/')[0] : "(Folder Tidak Dikenali)";
    folderNameDiv.textContent = "ðŸ“ Folder: " + currentFolderName;
  } else {
    currentFolderName = "";
    folderNameDiv.textContent = "";
  }
  if (autoCaptionCheckbox.checked) isiAutoCaption();
});

// update caption when user toggles checkbox
autoCaptionCheckbox.addEventListener('change', () => {
  if (autoCaptionCheckbox.checked) {
    // ensure currentFiles is up-to-date
    currentFiles = Array.from(upload.files || []);
    isiAutoCaption();
  }
});

// update when sizeSelect changes (capacity per page changes)
sizeSelect.addEventListener('change', () => {
  if (autoCaptionCheckbox.checked) isiAutoCaption();
});

// also clear auto caption when reset is clicked - keep behavior safe
resetBtn.addEventListener('click', () => {
  currentFolderName = "";
  if (autoCaptionCheckbox.checked) captionInput.value = "";
});
/* --------------------------------------------------------------------------- */

</script>

</body>
</html>
